<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Prenotazioni</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
        }
        .calendar-navigation, .time-slot-selection, .confirmation {
            margin-bottom: 20px;
        }
        .calendar {
            display: flex;
            flex-direction: column;
        }
        .week {
            display: flex;
        }
        .day {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .day.selectable {
            background-color: #4CAF50;
            color: white;
        }
        .time-slots button {
            margin-right: 5px;
            padding: 10px;
            cursor: pointer;
        }
        .time-slot.booked {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <h1>Seleziona una data (solo martedì, mercoledì, venerdì)</h1>
    <div class="calendar-navigation">
        <button id="prevMonth">Precedente</button>
        <h2 id="currentMonthYear"></h2>
        <button id="nextMonth">Successivo</button>
    </div>

    <div id="calendar" class="calendar"></div>

    <div id="timeSlotSelection" class="time-slot-selection" style="display: none;">
        <h2>Seleziona una fascia oraria:</h2>
        <div id="timeSlots" class="time-slots"></div>
        <button id="confirmSlot" style="display: none;">Conferma fascia oraria</button>
    </div>

    <div id="confirmation" class="confirmation" style="display: none;">
        <h3 id="confirmedTimeSlot"></h3>
    </div>

    <script>
        const SHEET_ID = '1hVwmKzQlQUGnNsROgruDM6adGaXXZT9uVdhkz0x45Vs';  // Inserisci il tuo ID di Google Sheets
        const API_KEY = 'AIzaSyDPXHsfUhMOIyJhy7yP9jzTgcNmARSispw';    // Inserisci la tua chiave API di Google
        const timeSlots = {
            2: ['21:00', '22:00', '23:00'],  // Martedì
            3: ['20:00', '21:00', '22:00', '23:00'],  // Mercoledì
            5: ['20:00', '21:00', '22:00', '23:00'],  // Venerdì
        };

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let selectedTimeSlot = null;
        let bookedTimeSlots = [];
        let timeSlotConfirmed = false;

        function fetchBookedSlots(date) {
            // Simula una richiesta API per ottenere le fasce orarie prenotate
            return new Promise((resolve) => {
                const formattedDate = date.toISOString().split('T')[0];
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Bookings!A2:C?key=${API_KEY}`)
                    .then(response => response.json())
                    .then(data => {
                        const rows = data.values || [];
                        const bookedSlots = rows.filter(row => row[0] === formattedDate).map(row => row[1]);
                        resolve(bookedSlots);
                    });
            });
        }

        function updateCalendar() {
            const calendarElement = document.getElementById('calendar');
            const currentMonthYear = document.getElementById('currentMonthYear');
            currentMonthYear.textContent = `${currentMonth + 1} ${currentYear}`;
            const calendar = generateCalendar(currentYear, currentMonth);

            calendarElement.innerHTML = '';
            calendar.forEach(week => {
                const weekElement = document.createElement('div');
                weekElement.classList.add('week');
                week.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.classList.add('day');
                    if (day) {
                        dayElement.textContent = day.getDate();
                        if (isSelectableDay(day)) {
                            dayElement.classList.add('selectable');
                            dayElement.onclick = () => handleDayClick(day);
                        }
                    }
                    weekElement.appendChild(dayElement);
                });
                calendarElement.appendChild(weekElement);
            });
        }

        function generateCalendar(year, month) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            let calendar = [];
            let day = 1;

            for (let i = 0; i < 6; i++) {
                let week = [];
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDay) {
                        week.push(null);
                    } else if (day > daysInMonth) {
                        break;
                    } else {
                        week.push(new Date(year, month, day));
                        day++;
                    }
                }
                calendar.push(week);
            }
            return calendar;
        }

        function isSelectableDay(date) {
            const dayOfWeek = date.getDay();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return (dayOfWeek === 2 || dayOfWeek === 3 || dayOfWeek === 5) && date >= today;
        }

        function handleDayClick(date) {
            selectedDate = date;
            document.getElementById('timeSlotSelection').style.display = 'block';
            document.getElementById('confirmSlot').style.display = 'none';
            selectedTimeSlot = null;
            timeSlotConfirmed = false;

            fetchBookedSlots(selectedDate).then(slots => {
                bookedTimeSlots = slots;
                renderTimeSlots();
            });
        }

        function renderTimeSlots() {
            const timeSlotsElement = document.getElementById('timeSlots');
            const dayOfWeek = selectedDate.getDay();
            timeSlotsElement.innerHTML = '';

            timeSlots[dayOfWeek].forEach(slot => {
                const button = document.createElement('button');
                button.textContent = slot;
                button.classList.add('time-slot');
                if (bookedTimeSlots.includes(slot)) {
                    button.classList.add('booked');
                    button.disabled = true;
                } else {
                    button.onclick = () => handleTimeSlotClick(slot);
                }
                timeSlotsElement.appendChild(button);
            });
        }

        function handleTimeSlotClick(slot) {
            selectedTimeSlot = slot;
            document.getElementById('confirmSlot').style.display = 'block';
        }

        function handleConfirmTimeSlot() {
            if (selectedTimeSlot && selectedDate) {
                const formattedDate = selectedDate.toISOString().split('T')[0];
                const requestBody = {
                    values: [[formattedDate, selectedTimeSlot, "Prenotato"]]
                };

                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Bookings!A2:C:append?valueInputOption=USER_ENTERED&key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                }).then(response => {
                    if (response.ok) {
                        alert('Prenotazione confermata!');
                        document.getElementById('confirmation').style.display = 'block';
                        document.getElementById('confirmedTimeSlot').textContent = `Fascia oraria confermata: ${selectedTimeSlot}`;
                        timeSlotConfirmed = true;
                    } else {
                        alert('Errore nella prenotazione.');
                    }
                });
            }
        }

        document.getElementById('confirmSlot').onclick = handleConfirmTimeSlot;
        document.getElementById('prevMonth').onclick = () => {
            if (currentMonth === 0) {
                currentMonth = 11;
                currentYear--;
            } else {
                currentMonth--;
            }
            updateCalendar();
        };
        document.getElementById('nextMonth').onclick = () => {
            if (currentMonth === 11) {
                currentMonth = 0;
                currentYear++;
            } else {
                currentMonth++;
            }
            updateCalendar();
        };

        updateCalendar();
    </script>
</body>
</html>
